pipeline {
    agent { 
        node { label 'docker-agent-python' }
    }
    triggers {
        pollSCM '* * * * *'
    }
    stages {
        stage('Build') {
            steps {
            
                echo "Installing dependencies..."
                // On ajoute || true pour ne pas crash si le fichier est absent
                sh '''
                cd myapp
                pip install -r requirements.txt
                pip install -r requirements.txt || echo "Pas de requirements.txt"
                '''
            }
        }
      stage('Test & Preview') {
    steps {
        script {
            // On se déplace dans le dossier s'il y en a un (vu dans tes logs: cd myapp)
            sh '''
            cd myapp || echo "Déjà à la racine"
            export JENKINS_NODE_COOKIE=dontKillMe
            export FLASK_APP=app.py
            
            # UTILISE CETTE COMMANDE PRÉCISE :
            python3 -m flask run --host=0.0.0.0 --port=5000 &
            '''
            
            sleep 10 // On laisse un peu plus de temps (10s) pour le chargement
            
            input message: "Vérifie http://localhost:5000 (ou l'IP de ton serveur). Clique sur Proceed quand tu as fini."
        }
    }
}
        stage('Deliver') {
            steps {
                sh 'echo "Nettoyage..." && pkill python3 || true'
            }
        }
    }
}
